CREATE TABLE users (
  id BIGSERIAL PRIMARY KEY,
  username TEXT NOT NULL UNIQUE,
  email TEXT NOT NULL UNIQUE,
  created_at TIMESTAMPTZ DEFAULT now(),
  preferences JSONB
);

CREATE TABLE items (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT REFERENCES users(id) ON DELETE CASCADE,
  image_path TEXT,
  category TEXT,
  color_name TEXT,
  color_hex TEXT CHECK (color_hex ~ '^#([0-9A-Fa-f]{6})$'),
  waterproof BOOLEAN,
  warmth TEXT CHECK (warmth IN ('summer','transition','winter')),
  formality TEXT CHECK (formality IN ('casual','business','party')),
  tags JSONB,
  ai_confidence REAL CHECK (ai_confidence BETWEEN 0 AND 1),
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE outfits (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT REFERENCES users(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  description TEXT,
  weather_tag TEXT,
  color_focus TEXT,
  formality TEXT,
  created_by_ai BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE outfit_items (
  id BIGSERIAL PRIMARY KEY,
  outfit_id BIGINT REFERENCES outfits(id) ON DELETE CASCADE,
  item_id BIGINT REFERENCES items(id) ON DELETE CASCADE,
  role TEXT CHECK (role IN ('top','bottom','shoes','outerwear')),
  image_path TEXT,
  UNIQUE (outfit_id, item_id)
);

CREATE TABLE prompts (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT REFERENCES users(id) ON DELETE CASCADE,
  raw_text TEXT NOT NULL,
  parsed_json JSONB,
  created_at TIMESTAMPTZ DEFAULT now(),
  related_outfit_id BIGINT REFERENCES outfits(id) ON DELETE SET NULL
);

CREATE TABLE settings (
  id BIGSERIAL PRIMARY KEY,
  key TEXT UNIQUE NOT NULL,
  value TEXT,
  updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_items_user ON items(user_id);
CREATE INDEX idx_items_filters ON items(formality, category, waterproof);
CREATE INDEX idx_items_color ON items(color_name, color_hex);
CREATE INDEX idx_items_tags_gin ON items USING GIN (tags);

CREATE INDEX idx_prompts_user ON prompts(user_id);
CREATE INDEX idx_outfits_user ON outfits(user_id);

